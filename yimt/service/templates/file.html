<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head> 
    <link rel="stylesheet" type="text/css" href="../static/text.css">
    <script src="../static/common.js" type="text/javascript"></script>
    <script>
        var API_KEY = "";
        var END_POINT = "http://127.0.0.1:5555";
        window.onload = function()
        {
            var server = window.localStorage.getItem("server");
            var key = window.localStorage.getItem("key");
            API_KEY=key;
            if(!!server)
            {
                END_POINT = server;
            }
            var userAgentInfo = navigator.userAgent;
            var Agents = ["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"];
            var flag = true;

            var is_finished = true;//
            for(var v=0;v<Agents.length;v++)
            {
                if(userAgentInfo.indexOf(Agents[v])>0)
                {
                    flag=false;
                    break;
                }
            }
            var tag=window.localStorage.getItem("tag");
            //alert(tag);
            if(!flag&&tag!="jump")
            {
                window.location.href="{{url_for('mobile')}}"
            }
            get_common_html();
            document.getElementById("url_setting_label").addEventListener("click", url_setting_func);
            request_ad();      
        }

        async function request_ad(){
            const res = await fetch(END_POINT + "/request_ad", {
                method: "POST",
                body: JSON.stringify({platform:"web"}),
                headers: { "Content-Type": "application/json" },
                }
            );
            trans_json = await res.json();
            ad_id = trans_json.ad_id;
            type = trans_json.type;
            content = trans_json.content;
            url = trans_json.url;
            console.log("ad_id:"+ad_id);
            console.log("ad_type:"+type);
            //console.log("ad_content:"+content);
            //console.log("ad_url:"+url);
            //document.getElementById("content").setAttribute("",)
            if(url != ""){
                ad_url = document.getElementById("product1_url");
                ad_url.style.visibility='visible';
                ad_url.href = url;
                //console.log("ad_url.href: "+ad_url.href);
            }else{
                document.getElementById("product1_url").style.visibility='hidden';
            }
            if(type == "text"){
                document.getElementById("product1_content").style.visibility='visible';
                document.getElementById("product1_content").innerText = content;
                //console.log(content);
            }else if(type == "image"){
                document.getElementById("product1_content").style.visibility='hidden';
                const base64String = content;
                ad_img_div = document.getElementById("product1_area");
                ad_img_div.style.backgroundImage='url('+'data:image/png;base64,'+content+')';
                ad_img_div.style.backgroundSize = "contain";
                ad_img_div.style.backgroundPosition = "center";
                ad_img_div.style.backgroundRepeat = "no-repeat";
            }else{
                document.getElementById("product1_content").innerText = "出错啦";
            }
        }

        var is_finished = true;//

        var xhr;
       
		function uploadFile() {
		    var fileObj = document.getElementById("select_file").files[0];
            var files = document.getElementById("select_file").files;
            if(files.length==0)
            {
                return;
            }
            document.getElementById("showProgress").innerHTML = "正在上传";//
            document.getElementById("showProgress").style.display ="block";
            document.getElementById("progress_line").style.display ="block";
            document.getElementById("download").style.display = "none";

            source_lang = document.getElementById('source').value;
            target_lang = document.getElementById('target').value;

            END_POINT = window.localStorage.getItem("server");
            API_KEY = window.localStorage.getItem("key");
            if(END_POINT=="")
            {
                END_POINT = "http://127.0.0.1:5555";
            }

		    console.log(fileObj);

		    var form = new FormData();
		    form.append("file", fileObj);
		    form.append("source", source_lang);
		    form.append("target", target_lang);
            form.append("api_key", API_KEY);

		    var url = END_POINT + "/translate_file";
		    xhr = new XMLHttpRequest();
            is_finished = false;//
            
            xhr.upload.addEventListener("progress", function(evt){
                if (evt.lengthComputable) {
                    var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                    if (percentComplete == 100){
                        setTimeout(function () {
                        //document.getElementById("showProgress").innerHTML = '上传完成，正在翻译...';
                        document.getElementById("progress_line").value=percentComplete;
                    },10)
                    }else{
                        document.getElementById("showProgress").innerHTML = '已上传'+percentComplete+"%";
                        document.getElementById("progress_line").value=percentComplete;
                    }
                }else {
                    document.getElementById("showProgress").innerHTML = '无法计算';
                }
                }, false);
		    xhr.open("post", url, true);
		    xhr.onload = uploadComplete;
		    xhr.send(form);

            setInterval("translate_progress()",200);  //每0.2秒发送查看进度  
		}

        function translate_progress(){
            //console.log(is_finished);  //测试用
            if(is_finished == false)
            {
                var url = END_POINT + "/translate_file_progress";
                //alert(url); //测试用
                var fileObj = document.getElementById("select_file").files[0];
                var form = new FormData();
		        form.append("file", fileObj);
                xhr = new XMLHttpRequest();
                xhr.onload = function(){
                    if(is_finished == false)  //得添加这句判断，否则会在上传结束后仍短暂执行下面的语句
                    {
                        console.log(this.responseText); //测试用
                        //console.log("is_finished?");  //测试用
                        document.getElementById("showProgress").innerHTML = '上传完成，正在翻译,翻译进度：'+ this.responseText;
                    } 
                }
                xhr.open("POST",url);
                xhr.send(form);    
            }
            else
            {
                document.getElementById("showProgress").innerHTML = "翻译完成，点击链接下载";
            }
        }

		function uploadComplete(evt) {
			//alert(evt.target.responseText);
			res_json = JSON.parse(evt.target.responseText);
			if(res_json.error){
			    //alert(res_json.error);//
			    return;
			}
			//alert(res_json)//
			//alert(res_json.translatedFileUrl);
			document.getElementById("download").style.display = "inline";
            //document.getElementById("showProgress").innerHTML = '翻译完成，点击链接下载';
            is_finished = true  //标记翻译结束
			document.getElementById('download').innerHTML = "<a href=" + res_json.translatedFileUrl + ">下载翻译文件</a>";
            var file_path = res_json.filepath;
            var translated_file_path = res_json.translated_file_path;
            var file_type = res_json.file_type;
            //console.log("file_path: "+ file_path);
            //console.log("translated_file_path: "+translated_file_path);
            //console.log("file_type: "+file_type);
            window.localStorage.setItem("file_path", file_path);
            window.localStorage.setItem("translated_file_path", translated_file_path);
            window.localStorage.setItem("file_type", file_type);

            window.location.href="{{url_for('reference')}}";
		}

	</script>

    <title>YiMT Doc Translation</title>
</head>

<body>
    <div class="mask" id="mask"></div>
    <div class="url_setting_block" id="url_setting_block"></div>
   
    <div class="fanyi__nav" id="fanyi__nav">
    
        <script>
            function url_setting_func()
            {
                END_POINT = window.localStorage.getItem("server");
                API_KEY = window.localStorage.getItem("key");
                if(END_POINT=="")
                {
                    END_POINT = "http://127.0.0.1:5555";
                }

                document.getElementById("url_setting_block").style.visibility='visible';
                document.getElementById("mask").style.display='block';
                document.getElementById("url").value=END_POINT;
                document.getElementById("api_key").value=API_KEY;
            }

            function url_resetting_func()
            {
                END_POINT = document.getElementById("url").value;
                window.localStorage.setItem("server", END_POINT);

                API_KEY = document.getElementById("api_key").value;
                window.localStorage.setItem("key", API_KEY);

                document.getElementById("url_setting_block").style.visibility='hidden';
                document.getElementById("mask").style.display='none';
            }
         
            function url_setting_hide_func()
            {
                document.getElementById("url_setting_block").style.visibility='hidden';
                document.getElementById("mask").style.display='none'
            }

            //document.getElementById("url_setting_label").addEventListener("click", url_setting_func);
        </script>
    </div>

    <div class="restriction">
        <div class="fanyi__operations">
            <div class="fanyi__operations--left">
                <div id="toolbar">
    
                    <select id="source" name="source" class="source_select">
                        <option value="auto">自动检测</option>
                        <option value="zh">Chinese</option>
                        <option value="en">English</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="de">German</option>
                        <option value="vi">Vietnamese</option>
                        <option value="ru">Russian</option>
                        <option value="ar">Arabic</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="pt">Portuguese</option>
                        <option value="ms">Malay</option>
                        <option value="hi">Hindi</option>
                        <option value="it">Italian</option>
                        <option value="th">Thai</option>
                        <option value="id">Indonesian</option>
                    </select>
                    <span class="mid">-></span>
                    <select id="target" name="target" class="target_select">
                        <option value="zh">Chinese</option>
                        <option value="en">English</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="de">German</option>
                        <option value="vi">Vietnamese</option>
                        <option value="ru">Russian</option>
                        <option value="ar">Arabic</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="pt">Portuguese</option>
                        <option value="ms">Malay</option>
                        <option value="hi">Hindi</option>
                        <option value="it">Italian</option>
                        <option value="th">Thai</option>
                        <option value="id">Indonesian</option>
                    </select>
                    <input type="button" class="fanyi__operations--machine" id="transMachine" value="翻译" >
                </div>
    
            </div>
    
        </div>
    
        <div class="fanyi__input_file">
            <div class="input__original_file">
                <div style=" display: inline-block;padding-top:12pt;text-align:center; font-size: 14px;color: #818181;">点 击 上 传</div>
                <div class="input_area_file">
                    <div class="image_container">
                        <div class="image">
                        </div>
                        <input type="file" class="select_file" id="select_file" onchange="uploadFile()">
                    </div> 
                </div>             
                <div style=" padding-bottom:10px;text-align:center; font-size: 14px;color: #848484;">支持以下类型文档：txt、pdf、docx、pptx、html/html/xml 等</div>
            </div>
       
        </div>
        <progress id="progress_line" class="progress_line" value="0" max="100"> </progress>
        <a id="showProgress" style="display:none;text-align:center; font-size: 19px;color: #357aa1;z-index: 6;">11</a>

        <div style="padding-top:0pt;text-align:center;">
            <span id="download" class="download">下载链接link</span>
        </div>
        
        <div class="inside__products" id="inside__products" style="display: block;"></div>
    </div>
    <div class="fanyi__footer" id="fanyi__footer"></div>
</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head> 
    <link rel="stylesheet" type="text/css" href="../static/text.css">
    <link rel="stylesheet" type="text/css" href="../static/reference.css">
    <script src="../static/common.js" type="text/javascript"></script>

    <!-- jquery -->
    <script type="text/javascript" src="../static/plugin/jquery-2.2.1.min.js"></script>
    <script type="text/javascript" src="../static/plugin/jquery.media.js"></script>
        
    <script>
        var file_type = "";
        var END_POINT
        window.onload = function()
        {
            END_POINT = "http://127.0.0.1:5555";
            var server = window.localStorage.getItem("server");
            if(!!server){
                END_POINT = server;
            }
            //console.log(END_POINT)  //for test
            var file_type = window.localStorage.getItem("file_type");
            var file_path = window.localStorage.getItem("file_path");
            var translated_file_path = window.localStorage.getItem("translated_file_path");
            //console.log(file_type);
            //console.log(file_path);
            //console.log(translated_file_path);
            var randomNumber = Math.floor(Math.random() * 1000000);
            document.getElementById("document-container").setAttribute("src", END_POINT + "/tph_original" + '?timestamp=' + randomNumber + '&file_path=' + encodeURIComponent(file_path)+ '&file_type=' + file_type);
            document.getElementById("document-container2").setAttribute("src", END_POINT+"/tph_target"+ '?timestamp=' + randomNumber + '&translated_file_path=' + encodeURIComponent(translated_file_path)+ '&file_type=' + file_type);
            get_download();     
            get_common_html(); 
            document.getElementById("url_setting_label").addEventListener("click", url_setting_func);          
            request_ad(); 
        }

        async function request_ad(){
            const res = await fetch(END_POINT + "/request_ad", {
                method: "POST",
                body: JSON.stringify({platform:"web"}),
                headers: { "Content-Type": "application/json" },
                }
            );
            trans_json = await res.json();
            ad_id = trans_json.ad_id;
            type = trans_json.type;
            content = trans_json.content;
            url = trans_json.url;
            console.log("ad_id:"+ad_id);
            console.log("ad_type:"+type);
            //console.log("ad_content:"+content);
            //console.log("ad_url:"+url);
            //document.getElementById("content").setAttribute("",)
            if(url != ""){
                ad_url = document.getElementById("product1_url");
                ad_url.style.visibility='visible';
                ad_url.href = url;
                //console.log("ad_url.href: "+ad_url.href);
            }else{
                document.getElementById("product1_url").style.visibility='hidden';
            }
            if(type == "text"){
                document.getElementById("product1_content").style.visibility='visible';
                document.getElementById("product1_content").innerText = content;
                //console.log(content);
            }else if(type == "image"){
                document.getElementById("product1_content").style.visibility='hidden';
                const base64String = content;
                ad_img_div = document.getElementById("product1_area");
                ad_img_div.style.backgroundImage='url('+'data:image/png;base64,'+content+')';
                ad_img_div.style.backgroundSize = "contain";
                ad_img_div.style.backgroundPosition = "center";
                ad_img_div.style.backgroundRepeat = "no-repeat";
            }else{
                document.getElementById("product1_content").innerText = "出错啦";
            }
        }

        async function get_download()
        {
            let xhr = new XMLHttpRequest();
            var form = new FormData();
            var translated_file_path = window.localStorage.getItem("translated_file_path");
            //alert(translated_file_path);
            form.append("translated_file_path", translated_file_path);
            xhr.open('POST',END_POINT + "/get_download");
            xhr.send(form);
            xhr.onreadystatechange = function () {
                console.log("get_download: "+ xhr.responseText);
                document.getElementById('download_link').innerHTML = "<a href=" + xhr.responseText + ">下载翻译文件</a>";
            }
        }
	</script>

    <title>YiMT Doc Translation</title>
</head>

<body>
    <div class="mask" id="mask"></div>
    <div class="url_setting_block" id="url_setting_block"></div>
   
    <div class="fanyi__nav" id="fanyi__nav">

        <script>
            function url_setting_func()
            {
                END_POINT = window.localStorage.getItem("server");
                API_KEY = window.localStorage.getItem("key");
                if(END_POINT=="")
                {
                    END_POINT = "http://127.0.0.1:5555";
                }

                document.getElementById("url_setting_block").style.visibility='visible';
                document.getElementById("mask").style.display='block';
                document.getElementById("url").value=END_POINT;
                document.getElementById("api_key").value=API_KEY;
            }

            function url_resetting_func()
            {
                END_POINT = document.getElementById("url").value;
                window.localStorage.setItem("server", END_POINT);

                API_KEY = document.getElementById("api_key").value;
                window.localStorage.setItem("key", API_KEY);

                document.getElementById("url_setting_block").style.visibility='hidden';
                document.getElementById("mask").style.display='none';
            }
         
            function url_setting_hide_func()
            {
                document.getElementById("url_setting_block").style.visibility='hidden';
                document.getElementById("mask").style.display='none'
            }

            //document.getElementById("url_setting_label").addEventListener("click", url_setting_func);
        </script>
    </div>

    <div class="restriction">
        <div class="ref_fanyi__operations">    
            <span class="original_title">原文文档</span>
            <span class="target_title">目标文档</span>
            <span id="download_link" class="download_link">下载链接</span>
        </div>
    
        <div class="fanyi__input">
 
            <div class="file_view_original">
                <!-- <iframe class="document-container" id="document-container" src="http://127.0.0.1:5555/media_original"></iframe> -->
                <iframe class="document-container" id="document-container" ></iframe>
            </div>

            <div class="file_view_target">
                <!-- <iframe class="document-container" id="document-container2" src="http://127.0.0.1:5555/media_target"></iframe> -->
                <iframe class="document-container" id="document-container2" ></iframe>
            </div>
            <script>
                
                var API_KEY = "";
                var END_POINT = "http://127.0.0.1:5555";
            </script>
           
        </div>

        <div class ="download_area"></div>

        <div class="inside__products" id="inside__products" style="display: block;"></div>
    </div>
    <div class="fanyi__footer" id="fanyi__footer"></div>
</body>
</html>
